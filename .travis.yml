matrix:
  include:
    - language: swift
      os: osx
      osx_image: xcode11.1
      if: (branch = master OR branch = alpha OR branch = refactor) AND commit_message !~ /(no-deploy)/
      cache:
        yarn: true
        bundler: true
        cocoapods: true
        directories:
          - "$HOME/.yarn-cache"
          - node_modules
          - packages/mobile-app/node_modules
          - packages/mobile-ui/node_modules
      node_js: false
      before_install:
        - nvm install 10
        - node --version
        - npm install -g yarn
        - yarn -version
        - gem install fastlane
        - echo -e "machine github.com\n  login $GITHUB_API_TOKEN" >> ~/.netrc
        - n=$(which node);n=${n%/bin/node}; chmod -R 755 $n/bin/*; sudo cp -r $n/{bin,lib,share} /usr/local
      install:
        - yarn install
        - yarn pods
        - cd packages/mobile-app/ios
        - bundle install
        - cd $TRAVIS_BUILD_DIR
      script:
        - echo $SECURE_PASSWORD | gpg --passphrase-fd 0 packages/mobile-app/.env.alpha.gpg
        - echo $SECURE_PASSWORD | gpg --passphrase-fd 0 packages/mobile-app/.env.beta.gpg
        - echo $SECURE_PASSWORD | gpg --passphrase-fd 0 packages/mobile-app/.env.production.gpg
        - cd packages/mobile-app/ios
        - bundle exec fastlane ios beta
        - cd $TRAVIS_BUILD_DIR
      after_success:
        - ".travis/push.sh"

    # Android
    - language: android
      if: (branch = master OR branch = alpha OR branch = refactor) AND commit_message !~ /(no-deploy)/
      os: linux
      jdk: oraclejdk8
      sudo: required
      android:
        components:
          - platform-tools
          - tools
          - build-tools-26.0.3
          - build-tools-28.0.3
          - android-21
          - android-26
          - android-28
          - sys-img-armeabi-v7a-android-21
          - extra-android-m2repository
          - extra-google-m2repository
          - extra-google-google_play_services
      node_js: false
      before_install:
        - echo $SECURE_PASSWORD | gpg --passphrase-fd 0 packages/mobile-app/android/my-release-key.keystore.gpg
        - echo $SECURE_PASSWORD | gpg --passphrase-fd 0 packages/mobile-app/android/democracy2-release-key.keystore.gpg
        - echo $SECURE_PASSWORD | gpg --passphrase-fd 0 packages/mobile-app/.env.alpha.gpg
        - echo $SECURE_PASSWORD | gpg --passphrase-fd 0 packages/mobile-app/.env.beta.gpg
        - echo $SECURE_PASSWORD | gpg --passphrase-fd 0 packages/mobile-app/.env.production.gpg
        - echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo
          sysctl -p
        - nvm install 10
        - node --version
        - npm install -g yarn
        - yarn -version
        - gem install fastlane
        - echo -e "machine github.com\n  login $GITHUB_API_TOKEN" >> ~/.netrc
      install:
        - yarn install --no-bin-links
        - cd packages/mobile-app/android
        - bundle install
        - cd $TRAVIS_BUILD_DIR
      script:
        - cd packages/mobile-app/android
        - bundle exec fastlane android internal
        - cd $TRAVIS_BUILD_DIR
      after_success:
        - ".travis/push.sh"
